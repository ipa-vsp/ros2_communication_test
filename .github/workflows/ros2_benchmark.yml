name: ROS 2 Benchmark Matrix

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  benchmark:
    runs-on: ubuntu-latest
    container:
      image: ros:${{ matrix.ros_distro }}-ros-base
    strategy:
      fail-fast: false
      matrix:
        ros_distro: [jazzy, humble]
        rmw: [rmw_fastrtps_cpp, rmw_cyclonedds_cpp]
        reliability: [reliable, besteffort]
        durability: [volatile, transient_local]
    env:
      ROS_DISTRO: ${{ matrix.ros_distro }}
      RMW_IMPLEMENTATION: ${{ matrix.rmw }}
      RELIABILITY: ${{ matrix.reliability }}
      DURABILITY: ${{ matrix.durability }}
      RESULT_FILE: ${{ format('results/{0}/{1}_{2}_{3}_{4}.csv', matrix.ros_distro, matrix.ros_distro, matrix.rmw, matrix.reliability, matrix.durability) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          apt_pkg="ros-${ROS_DISTRO}-${RMW_IMPLEMENTATION//_/-}"
          apt-get update
          apt-get install -y --no-install-recommends python3-pip "$apt_pkg" python3-pandas python3-numpy

      - name: Run benchmark
        shell: bash
        run: |
          set -euxo pipefail
          export AMENT_TRACE_SETUP_FILES=0
          export AMENT_PYTHON_EXECUTABLE="$(command -v python3)"
          source /opt/ros/$ROS_DISTRO/setup.bash
          mkdir -p "$(dirname "$RESULT_FILE")"
          python3 scripts/ros2_benchmark.py \
            --distro "$ROS_DISTRO" \
            --rmw "$RMW_IMPLEMENTATION" \
            --reliability "$RELIABILITY" \
            --durability "$DURABILITY" \
            --output "$RESULT_FILE"

      - name: Inspect results
        shell: bash
        run: |
          set -euxo pipefail
          ls -R results
          head -n 5 "$RESULT_FILE"

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('{0}-{1}-{2}-{3}-benchmark', matrix.ros_distro, matrix.rmw, matrix.reliability, matrix.durability) }}
          path: ${{ env.RESULT_FILE }}
